
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>AR.js Demo (Fixed)</title>

<!-- A-Frame 固定版 -->
https://aframe.io/releases/1.5.0/aframe.min.js</script>
<!-- AR.js for A-Frame 固定版（jsDelivrでタグ固定） -->
https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar.js</script>

<style>
  body { margin:0; overflow:hidden; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; }
  .arjs-loader {
    position: fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    background:#fff; z-index:9999;
  }
  .arjs-loader div { font-size:16px; color:#333; }
  /* デバッグ用の生映像プレビューを隠す（必要なら表示切替） */
  #preview { position:fixed; left:-9999px; top:-9999px; width:1px; height:1px; }
  #togglePreview { position:fixed; right:8px; bottom:8px; z-index:10000;
    padding:8px 10px; background:#444; color:#fff; border:none; border-radius:8px; font-size:12px;}
</style>
</head>

<body>
<div class="arjs-loader"><div>カメラ起動しました。AR初期化中…</div></div>
<button id="togglePreview" aria-label="toggle preview">映像確認</button>
<video id="preview" autoplay muted playsinline></video>

<a-scene
  embedded
  renderer="logarithmicDepthBuffer: true; colorManagement: true; alpha: true;"
  vr-mode-ui="enabled: false"
  arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best;
        videoTexture: true;
        cameraParametersUrl: https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/data/data/camera_para.dat;">
  <!-- 矢印 -->
  <a-marker type="pattern" url="arrow.patt" emitevents="true" smooth="true"
            smooth-count="10" smooth-tolerance="0.01" smooth-threshold="2">
    <a-cylinder position="0 0.10 0" radius="0.03" height="0.30" color="#ff2d2d"></a-cylinder>
    <a-cone position="0 0.35 0" radius-bottom="0.10" radius-top="0" height="0.25" color="#ff2d2d"></a-cone>
  </a-marker>

  <!-- 立方体 -->
  <a-marker type="pattern" url="cube.patt" emitevents="true" smooth="true"
            smooth-count="10" smooth-tolerance="0.01" smooth-threshold="2">
    <a-box color="#1e88e5" position="0 0.20 0" width="0.28" height="0.28" depth="0.28"></a-box>
  </a-marker>

  <!-- 警告 -->
  <a-marker type="pattern" url="warning.patt" emitevents="true" smooth="true"
            smooth-count="10" smooth-tolerance="0.01" smooth-threshold="2">
    <a-sphere color="#ffd54f" position="0 0.20 0" radius="0.14"></a-sphere>
    <a-text value="!" color="#111" position="0 0.36 0" align="center" side="double" scale="2 2 2"></a-text>
  </a-marker>

  <a-entity camera></a-entity>
</a-scene>

<script>
  // --- 生のカメラプレビュー（デバッグ用）
  const preview = document.getElementById('preview');
  const toggleBtn = document.getElementById('togglePreview');
  toggleBtn.addEventListener('click', () => {
    const hidden = preview.style.left === '-9999px';
    if (hidden) {
      preview.style.left = '8px'; preview.style.top = '8px';
      preview.style.width = '240px'; preview.style.height = '135px';
      toggleBtn.textContent = 'プレビュー非表示';
    } else {
      preview.style.left = '-9999px'; preview.style.top = '-9999px';
      preview.style.width = '1px'; preview.style.height = '1px';
      toggleBtn.textContent = '映像確認';
    }
  });

  // ページ読み込み後に生映像を先に起動（iOS対策は許可済みならOK）
  (async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      preview.srcObject = stream;
      await preview.play();
    } catch(e) { console.warn('preview failed:', e?.name, e?.message); }
  })();

  // --- AR初期化完了でローダーを消す
  const sceneEl = document.querySelector('a-scene');
  sceneEl.addEventListener('arReady', () => {
    document.querySelector('.arjs-loader').style.display = 'none';
    console.log('AR.js ready');
  });

  // --- 参考ログ（マーカー検出）
  document.querySelectorAll('a-marker').forEach(m => {
    m.addEventListener('markerFound', () => console.log('markerFound:', m.getAttribute('url')));
    m.addEventListener('markerLost',  () => console.log('markerLost:',  m.getAttribute('url')));
  });
</script>
</body>
</html>
