
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AR.js + A‑Frame（順序修正）</title>
  <style>body{margin:0;overflow:hidden}</style>
</head>
<body>
  <div id="app"></div>

  <script>
    const PATHS = {
      AFRAME: '/ardemo/aframe.min.js',   // ① A‑Frame（THREEを含む）
      CORE:   '/ardemo/ar-threex.js',    // ② AR.js threeコア（THREEx / jsartoolkit）
      ARJS:   '/ardemo/aframe-ar.js',    // ③ A‑Frameブリッジ（arjsコンポーネント登録）
      PATT:   '/ardemo/markers/yourmarker.patt'
    };
    const USE_HIRO = true;

    if (window.__ar_loader_started__) { console.warn('Loader already started.'); }
    else { window.__ar_loader_started__ = true; }

    async function loadTextAndEval(url) {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`Fetch failed: ${url} (${res.status})`);
      const text = await res.text();
      (0, eval)(text);
      console.log('[eval loaded]', url);
    }

    async function ensureLibs() {
      // ★ 正しい順序：AFRAME → CORE → ARJS
      if (!window.AFRAME) await loadTextAndEval(PATHS.AFRAME); // THREE が載る
      console.log('THREE exists after AFRAME?', !!window.THREE);

      if (!window.THREEx) await loadTextAndEval(PATHS.CORE);   // コア（THREEx/jsartoolkit）
      if (!AFRAME?.components?.arjs) await loadTextAndEval(PATHS.ARJS); // ブリッジ

      console.log('AFRAME defined?', !!window.AFRAME);
      console.log('THREE exists?', !!window.THREE);
      console.log('THREEx exists?', !!window.THREEx);
      console.log('AR.js component exists?', !!AFRAME.components['arjs']);

      if (!window.AFRAME || !window.THREE || !window.THREEx || !AFRAME.components['arjs']) {
        throw new Error('ライブラリのロードに失敗（順序/ファイル内容/保存ミスを確認）');
      }
    }

    function mountScene({ useHiro }) {
      const sceneHiro = `
        <a-scene embedded arjs>
          <a-box position="0 0.5 0" material="opacity:0.6; color:#4CC3D9"></a-box>
          <a-marker-camera preset="hiro"></a-marker-camera>
        </a-scene>`;
      const scenePattern = `
        <a-scene embedded arjs>
          <a-marker type="pattern" url="${PATHS.PATT}" emitevents="true">
            <a-box position="0 0.5 0" material="opacity:0.8; color:#EF2D5E"></a-box>
          </a-marker>
          <a-entity camera></a-entity>
        </a-scene>`;
      document.getElementById('app').innerHTML = useHiro ? sceneHiro : scenePattern;
    }

    (async () => {
      await ensureLibs();
      mountScene({ useHiro: USE_HIRO });
      console.log('[ready] シーン挿入完了。カメラ許可後にマーカーをかざしてください。');
    })().catch(err => { console.error(err); alert('読み込み失敗。コンソールをご確認ください。'); });
  </script>
</body>
</html>

