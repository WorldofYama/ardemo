
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>Marker AR 完全版（ローカルJSのみ）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- 相対パスの基準を /ardemo/ に固定（必要に応じて変更） -->
  /ardemo/

  <!-- ローカルJS（順番：Three版コア → A‑Frame → 橋渡し） -->
  arjs-core.min.js</script>
  aframe.min.js</script>
  aframe-ar.js</script>

  <style>
    html, body { margin:0; padding:0; background:#000; color:#fff; font-family:system-ui, sans-serif; }
    #ui { position:fixed; left:0; right:0; top:0; z-index:1000; padding:8px 12px; background:rgba(0,0,0,0.5); }
    #log { font-size:12px; white-space:pre-wrap; max-height:30vh; overflow:auto; margin-top:6px; }
    #start { margin-top:8px; padding:8px 12px; background:#1e90ff; color:#fff; border:none; border-radius:6px; }
    #hint { position:fixed; left:0; right:0; bottom:0; padding:8px 12px; font-size:14px; background:rgba(0,0,0,0.45); z-index:999; }
  </style>
</head>
<body>

  <!-- 画面上UI＆ログ -->
  <div id="ui">
    <div>ローカルJS：<strong>arjs-core.min.js / aframe.min.js / aframe-ar.js</strong></div>
    <button id="start">AR開始（カメラ許可が必要）</button>
    <div id="log"></div>
  </div>
  <div id="hint">
    マーカー（<strong>arrow / cube / warning</strong>）をカメラに映してください。<br>
    10cm角で表示。オブジェクトは「マーカー面から10cm浮き」。矢印は右向き（+X）。
  </div>

  <!-- A‑Frame シーン（AR.js を A‑Frame に接続済み） -->
  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true; antialias: true"
    arjs="sourceType: webcam; detectionMode: mono_and_matrix; patternRatio: 0.5; debugUIEnabled: true"
    id="scene">

    <!-- A‑Frameのカメラ（AR.js が射影を合わせます） -->
    <a-entity camera></a-entity>

    <!-- 起動確認用：hiro（任意） -->
    <!-- <a-marker type="pattern" url="markers/hiro.patt" size="0.10">
      <a-box position="0 0.15 0" depth="0.10" height="0.10" width="0.10" color="#32cd32"></a-box>
    </a-marker> -->

    <!-- ====== arrow：右向き（+X）・10cm角・マーカー面から10cm浮き ====== -->
    <a-marker type="pattern" url="markers/arrow.patt" size="0.10" id="mArrow">
      <!-- 親を y=0.10 に持ち上げて「底面が y=0.10」を実現 -->
      <a-entity position="0 0.10 0">
        <!-- 軸（Y軸形状をZ軸90°回転し、X方向へ） -->
        <a-cylinder position="0.05 0 0" rotation="0 0 90" radius="0.015" height="0.10" color="#1e90ff"></a-cylinder>
        <!-- 矢じり -->
        <a-cone     position="0.10 0 0" rotation="0 0 90" radius-bottom="0.035" radius-top="0.000" height="0.08" color="#ff7f50"></a-cone>
      </a-entity>
    </a-marker>

    <!-- ====== cube：一辺10cm・底面y=0.10（中心y=0.15） ====== -->
    <a-marker type="pattern" url="markers/cube.patt" size="0.10" id="mCube">
      <a-box position="0 0.15 0" depth="0.10" height="0.10" width="0.10" color="#32cd32"></a-box>
    </a-marker>

    <!-- ====== warning：黄色三角＋黒「！」・底面 ≈ y=0.10 ====== -->
    <a-marker type="pattern" url="markers/warning.patt" size="0.10" id="mWarn">
      <a-cone position="0 0.14 0" radius-bottom="0.06" radius-top="0.00" height="0.08" color="#ffd400"></a-cone>
      <a-text value="!" position="0 0.18 0" rotation="-90 0 0" align="center" color="#000000" width="0.6"></a-text>
    </a-marker>

  </a-scene>

  <script>
    // 画面ログ
    const logEl = document.getElementById('log');
    const log = m => { console.log(m); logEl.textContent += m + '\n'; };

    // 自己診断（ロード直後）
    (function selfCheck(){
      log('THREEx exists? ' + (typeof THREEx !== 'undefined'));
      log('AFRAME defined? ' + (typeof AFRAME !== 'undefined') + (AFRAME && AFRAME.version ? (' v' + AFRAME.version) : ''));
      const hasArjs = !!AFRAME && !!AFRAME.components && !!AFRAME.components['arjs'];
      log('AR.js (arjs component) loaded? ' + hasArjs);
    })();

    // 権限＆イベントログ
    document.getElementById('start').addEventListener('click', async () => {
      try {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          await navigator.mediaDevices.getUserMedia({ video: true });
          log('getUserMedia preflight OK');
        }
      } catch (e) {
        log('Camera permission error: ' + (e && e.name ? e.name : e));
      }

      // markerFound / markerLost ログ
      const mArrow = document.getElementById('mArrow');
      const mCube  = document.getElementById('mCube');
      const mWarn  = document.getElementById('mWarn');
      ['markerFound','markerLost'].forEach(ev => {
        mArrow.addEventListener(ev, () => log('arrow ' + ev));
        mCube .addEventListener(ev, () => log('cube '  + ev));
        mWarn .addEventListener(ev, () => log('warn '  + ev));
      });

      log('A-Frame scene ready? ' + document.getElementById('scene').hasLoaded);
    });
  </script>

</body>
</html>
