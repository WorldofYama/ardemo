
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AR.js + A‑Frame 完全版（fetch+eval / 自動フォールバック）</title>
  <style>body{margin:0;overflow:hidden}</style>
</head>
<body>
  <div id="app"></div>

  <script>
    // ===== 設定 =====
    const PATHS = {
      // ① A‑Frame（THREE を含む）
      AFRAME: '/ardemo/aframe.min.js',
      // ② AR.js three コア（THREEx / jsartoolkit）
      CORE:   '/ardemo/ar-threex.js',
      // ③ A‑Frameブリッジ（AR.js の A‑Frame 実装）
      ARJS:   '/ardemo/aframe-ar.js',

      // 独自パターンへの切替時に使用する .patt
      PATT:   '/ardemo/markers/yourmarker.patt'
    };

    // まずは Hiro で起動確認（true）→ 映ったら false にして pattern .patt へ
    const USE_HIRO = true;

    // ===== 2重起動防止 =====
    if (window.__ar_loader_started__) { console.warn('Loader already started.'); }
    else { window.__ar_loader_started__ = true; }

    // ===== fetch → eval（順序保証付き） =====
    async function loadTextAndEval(url) {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`Fetch failed: ${url} (${res.status})`);
      const text = await res.text();
      (0, eval)(text); // グローバルに評価
      console.log('[eval loaded]', url);
    }

    // ===== ライブラリ読込（AFRAME → CORE → ARJS） =====
    async function ensureLibs() {
      // ★ 正しい順序：AFRAME → CORE → ARJS
      if (!window.AFRAME) await loadTextAndEval(PATHS.AFRAME); // THREE が載る
      console.log('THREE exists after AFRAME?', !!window.THREE);

      if (!window.THREEx) await loadTextAndEval(PATHS.CORE);   // コア（THREEx / jsartoolkit）
      await loadTextAndEval(PATHS.ARJS);                       // ブリッジ（名称はビルド差あり）

      // 診断ログ
      console.log('AFRAME defined?', !!window.AFRAME);
      console.log('THREE exists?', !!window.THREE);
      console.log('THREEx exists?', !!window.THREEx);

      // どの名称が登録されたかを判定（arjs / artoolkit）
      const hasArjs       = !!AFRAME.components?.arjs;
      const hasArtoolkit  = !!AFRAME.components?.artoolkit;
      console.log('AR.js component (arjs)?', hasArjs);
      console.log('AR.js component (artoolkit)?', hasArtoolkit);

      if (!hasArjs && !hasArtoolkit) {
        // ここで失敗なら、aframe-ar.js のビルド／保存が壊れている可能性
        throw new Error('AR.js A‑Frameブリッジの登録に失敗（ビルド/保存/パスを確認）');
      }
      return { hasArjs, hasArtoolkit };
    }

